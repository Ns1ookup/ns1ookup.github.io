# Spring Data Commons远程代码执行漏洞(CVE-2018-1273)分析
## 1.漏洞介绍

Pivotal Spring官方发布安全公告，Spring Data Commons组件中存在远程代码执行漏洞（CVE-2018-1273），攻击者可构造包含有恶意代码的SPEL表达式实现远程代码攻击，直接获取服务器控制权限。

Spring Data是一个用于简化数据库访问，并支持云服务的开源框架,包含Commons、Gemfire、JPA、JDBC、MongoDB等模块。此漏洞产生于Spring Data Commons组件，该组件为提供共享的基础框架，适合各个子项目使用，支持跨数据库持久化。请受此漏洞影响用户尽快升级组件。

**漏洞影响版本：**

- 2.0.0-2.0.5
- 1.13.0-1.13.10
- 已经不支持的老版本


## 2.环境搭建

下载项目：https://github.com/spring-projects/spring-data-examples/

选择其中的/web/example项目，避免无法执行payload，将版本回退。spring-data-examples目录下的pom.xml文件parent标签修改为如下：

        <parent>
    		<groupId>org.springframework.boot</groupId>
    		<artifactId>spring-boot-starter-parent</artifactId>
    		<version>2.0.0.RC1</version>
    	</parent>

配置maven项目，目录指定web/example。配置如下：
![](https://i.imgur.com/pLHKOei.png)

运行该项目，当下载完配置文件后。为了调试过程中，可以追踪到springframework包中文件。打开IDEA右侧的maven,选择Dependencies中的jar进行下载。
![](https://i.imgur.com/hHFYQeK.png)


## 3.漏洞分析

### 漏洞验证
打开项目地址，输入数据并进行抓包
![](https://i.imgur.com/QBfb0m9.png)

构造SPLE表达式，使用`#this.getClass().forName("java.lang.Runtime").getRuntime().exec("calc.exe")`或`T(java.lang.Runtime).getRuntime().exec('calc.exe')`作为payload。执行结果如下：

![](https://i.imgur.com/gMNRT35.png)

### 补丁分析
查看controller中的映射关系，发现post请求的函数，此处下断点进行分析
![](https://i.imgur.com/nVDmJx4.png)

捕获到数据时，已经弹出了计算器。接着在此处下断点分析，由于此处为页面加载数据的函数。追踪到执行表达式的过程太复杂，不易分析
![](https://i.imgur.com/UL2OpnI.png)

查看补丁修复的位置，将StandardEvaluationContext替代为SimpleEvaluationContext。同样在CVE-2018-1270修复补丁中，删除了StandardEvaluationContext引用采用了SimpleEvaluationContext,StandardEvaluationContext可以执行任意SpEL表达式，Spring官方在5.0.5之后换用SimpleEvaluationContext，用于实现简单的数据绑定，保持灵活性减少安全隐患。

[https://github.com/spring-projects/spring-data-commons/commit/b1a20ae1e82a63f99b3afc6f2aaedb3bf4dc432a](https://github.com/spring-projects/spring-data-commons/commit/b1a20ae1e82a63f99b3afc6f2aaedb3bf4dc432a)

![](https://i.imgur.com/w01oIOX.png)

### 代码分析

在MapDataBinder.java文件的setPropertyValue处下断点

![](https://i.imgur.com/HnKvnxI.png)


先看一下SPEL表达式的基本用法

    //创建SpEL表达式的解析器
    ExpressionParser parser=new SpelExpressionParser();
    User user=new User(9527,"周星驰");
    //解析表达式需要的上下文，解析时有一个默认的上下文
    EvaluationContext ctx = new StandardEvaluationContext();
    //在上下文中设置变量，变量名为user，内容为user对象
    ctx.setVariable("user", user);
    //从用户对象中获得id并+1900，获得解析后的值在ctx上下文中
    int id = (Integer) parser.parseExpression("#user.getId() + 1900").getValue(ctx);
    System.out.println(id);

根据上述基本用法可以看出，需要对解析器进行解析，此处已完成设置
![](https://i.imgur.com/GYzn0nt.png)

解析了spel表达式，成功执行calc.exe
![](https://i.imgur.com/L5DYMEg.png)


## 4.漏洞利用payload分析


漏洞利用payload如下：

`#this.getClass().forName("java.lang.Runtime").getRuntime().exec("calc.exe")`

`T(java.lang.Runtime).getRuntime().exec('calc.exe')`

在spring-data-commons在2.0.5版本中不能使用SpEl表达式，添加了如下代码
![](https://i.imgur.com/AxQKwnE.png)

所以`T(java.lang.Runtime).getRuntime().exec('calc.exe')`在该版本中无法执行。利用 Java 反射机制可以绕过，this.getClass().forName(xxx)是加载指定的类。输出如下payload
    
  `#this.getClass().forName("java.lang.Runtime").getRuntime().exec("calc.exe")`

在 https://gist.github.com/matthiaskaiser/bfb274222c009b3570ab26436dc8799e 给出了另一个payload：

    #this.getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("js").eval("java.lang.Runtime.getRuntime().exec('xterm')")


## 5.修复建议
- 升级spring-data-commons版本2.0.6 以上
- SimpleEvaluationContext替代StandardEvaluationContext。实现简单的数据绑定，保持灵活性减少安全隐患

## 6.参考链接

https://xz.aliyun.com/t/2269